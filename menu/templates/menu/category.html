
{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="content-wrapper">
  <!-- Page Header -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Category</h1>
        </div>
         <div class="col-sm-6">
            <div class="text-right">
              <button class="btn btn-warning text-dark" data-toggle="modal" data-target="#addMenuModal">
          <i class="fas fa-plus"></i> Add Category
        </button>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
           
            <!-- /.card -->

            <div class="card">
              <!-- /.card-header -->
              <div class="card-body">
                <table id="example1" class="table table-bordered table-striped">
                  <thead>
                  <tr>
                    <th>Name</th>
                    <th>Discripsion</th>
                    <th>Actions</th>
                </tr>
                  </thead>
                  <tbody>
                  
               {% for category in categories %}
                  <tr>
                    <td>{{ category.name }}</td>
                    <td>{{ category.description }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditMenu(
                            '{{ category.id }}',
                            '{{ category.name }}',
                            '{{ category.description }}'
                          )">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-category-btn" data-id="{{ category.id }}">
                          <i class="fas fa-trash"></i> 
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                  <tr>
                    <th>Name</th>
                    <th>Discripsion</th>
                    <th>Actions</th>
                  </tr>
                  </tfoot>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div>
      <!-- /.container-fluid -->
    </section>
</div>



<!-- ðŸ”˜ Add Menu Item Modal -->
<div class="modal fade" id="addMenuModal" tabindex="-1" role="dialog" aria-labelledby="addMenuModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="addMenuModalLabel">Add Category</h5>
        <button type="button" class="close text-dark" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addMenuForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group">
            <label for="menu-name">Name</label>
            <input type="text" class="form-control" id="menu-name" name="name" placeholder="Enter item name" required>
          </div>
          <div class="form-group">
            <label for="menu-price">description</label>
            <input type="text" class="form-control" id="menu-price" name="price" placeholder="Enter price" step="0.01" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="saveMenuBtn">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Menu Item Modal -->
<div class="modal fade" id="editMenuModal" tabindex="-1" role="dialog" aria-labelledby="editMenuModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="editMenuModalLabel">Edit Categories</h5>
        <button type="button" class="close text-dark" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editMenuForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="edit-menu-id" name="id">
          <div class="form-group">
            <label for="edit-menu-name">Name</label>
            <input type="text" class="form-control" id="edit-menu-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="edit-menu-price">Discripsion</label>
            <input type="number" class="form-control" id="edit-menu-price" name="price" step="0.01" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="updateMenuBtn">Update</button>
      </div>
    </div>
  </div>
</div>

<script>
  function openEditMenu(itemId, name, categoryId, price, availability) {
    $('#edit-menu-id').val(itemId);
    $('#edit-menu-name').val(name);
    $('#edit-item-category').val(categoryId);
    $('#edit-menu-price').val(price);
    $('#edit-menu-availability').val(availability ? "Available" : "Unavailable");

    $('#editMenuModal').modal('show');
}

</script>

<!-- JavaScript -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<!-- JavaScript -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script>
  $(document).ready(function() {

    $('#saveMenuBtn').click(function() {
      const form = $('#addMenuForm')[0];
      const formData = new FormData(form);  

      // Basic validation before sending
      const name = formData.get('name');
      const discripsion = formData.get('discripsion');

      $.ajax({
        url: "{% url 'menu:add_category' %}",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        success: function(response) {
            alert('Category added successfully!');
            location.reload();
        },
        error: function(xhr) {
          alert('Error adding menu item. Please try again.');
        }
      });
    });
  });

  $('#updateMenuBtn').click(function() {
      const form = $('#editMenuForm')[0];
      const formData = new FormData(form);

      const id = formData.get('id');
      const name = formData.get('name');
      const discripsion = formData.get('discripsion');

      $.ajax({
          url: `/menu/edit_category/${id}/`,
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          success: function(response) {
              alert('category updated successfully!');
              location.reload();
          },
          error: function(xhr) {
              alert('Error updating menu item. Please try again.');
          }
      });
  });


  function deleteMenuItem(id, url) {
    if (!confirm("Are you sure you want to delete this menu item?")) return;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json',
      },
    })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert("Menu item deleted successfully!");
        location.reload();
      } else {
        alert('Error deleting menu item: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error(err);
      alert('Request failed. Check console for details.');
    });
  }
</script>
{% endblock %}